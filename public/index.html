<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë‚ ì”¨ ê¸°ë°˜ ì—¬í–‰ì§€ ì¶”ì²œ ì„œë¹„ìŠ¤</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }
    #form-container {
      padding: 20px;
      background: #f2f2f2;
    }
    .form-group {
      margin-bottom: 10px;
    }
    label {
      display: block;
      margin-bottom: 5px;
    }
    input, select {
      padding: 8px;
      width: 200px;
    }
    button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    #map {
      width: 100%;
      height: calc(100vh - 150px);
    }
  </style>
</head>
<body>

  <div id="form-container">
    <h1>ì—¬í–‰ì§€ ì¶”ì²œ ë°›ê¸°</h1>
    <div class="form-group">
      <label for="city">ë„ì‹œ ì„ íƒ:</label>
      <select id="city">
        <option value="ì„œìš¸">ì„œìš¸</option>
        <option value="ë¶€ì‚°">ë¶€ì‚°</option>
        <option value="ëŒ€êµ¬">ëŒ€êµ¬</option>
        <option value="ì¸ì²œ">ì¸ì²œ</option>
        <option value="ê´‘ì£¼">ê´‘ì£¼</option>
        <option value="ëŒ€ì „">ëŒ€ì „</option>
      </select>
    </div>
    <div class="form-group">
      <label for="datetime">ë‚ ì§œ ë° ì‹œê°„ ì„ íƒ:</label>
      <input type="datetime-local" id="datetime" />
    </div>
    <div class="form-group">
      <button id="getRecommendations">ì¶”ì²œ ë°›ê¸°</button>
    </div>
  </div>

  <div id="weather-info" style="padding: 10px; font-size: 16px;">
    <!-- ì˜ˆë³´ ë‚ ì”¨ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
  </div>

  <div id="map"></div>

  <!-- Leaflet JS ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ì§€ë„ ì´ˆê¸°í™”
    const map = L.map('map').setView([37.5665, 126.9780], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // ë§ˆì»¤ ê´€ë¦¬ìš© ë ˆì´ì–´ ê·¸ë£¹ ìƒì„±
    const markerLayer = L.layerGroup().addTo(map);

    // ì¹´í…Œê³ ë¦¬ ì½”ë“œ â†’ í•œê¸€ ë§¤í•‘
    const categoryMap = {
      "12": "ê´€ê´‘ì§€",
      "14": "ë¬¸í™”ì‹œì„¤",
      "15": "ì¶•ì œ/ê³µì—°/í–‰ì‚¬",
      "25": "ì—¬í–‰ì½”ìŠ¤",
      "28": "ë ˆí¬ì¸ ",
      "32": "ìˆ™ë°•",
      "38": "ì‡¼í•‘",
      "39": "ìŒì‹ì "
    };

    // ë„ì‹œë³„ ì¢Œí‘œ
    function getCityCoordinates(city) {
      switch(city) {
        case 'ì„œìš¸': return [37.5665, 126.9780];
        case 'ë¶€ì‚°': return [35.1796, 129.0756];
        case 'ëŒ€êµ¬': return [35.8714, 128.6014];
        case 'ì¸ì²œ': return [37.4563, 126.7052];
        case 'ê´‘ì£¼': return [35.1595, 126.8526];
        case 'ëŒ€ì „': return [36.3504, 127.3845];
        default: return [37.5665, 126.9780];
      }
    }

    // ì¶”ì²œ API í˜¸ì¶œ ë° ì§€ë„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function getRecommendations() {
      const city = document.getElementById('city').value;
      const datetimeInput = document.getElementById('datetime').value;
      
      if (!datetimeInput) {
        alert('ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      const datetime = datetimeInput;
      const [lat, lon] = getCityCoordinates(city);
      const apiUrl = `/api/recommendByForecast?lat=${lat}&lon=${lon}&datetime=${datetime}&city=${city}`;

      fetch(apiUrl)
        .then(res => res.json())
        .then(data => {
          // ë‚ ì”¨ ì •ë³´ í‘œì‹œ
          document.getElementById('weather-info').innerHTML = `
            <b>ì˜ˆë³´ ì‹œê°„:</b> ${data.forecast_time}<br/>
            <b>ë‚ ì”¨ ìƒíƒœ:</b> ${data.weather}<br/>
            <b>ê¸°ì˜¨:</b> ${data.temp.toFixed(1)}Â°C
          `;

          markerLayer.clearLayers();

          data.recommended_places.forEach(place => {
  const cat = categoryMap[place.category] || "ê¸°íƒ€";
  const marker = L.marker([place.latitude, place.longitude]);

  marker.on('click', function () {
    console.log('ğŸ“ contentid:', place.contentid);  // âœ… ì´ê±° ì°íˆëŠ”ì§€ í™•ì¸
    fetch(`/api/getImage?contentid=${place.contentid}`)
      .then(res => res.json())
      .then(imgData => {
        const imageTag = imgData.imageUrl
          ? `<img src="${imgData.imageUrl}" alt="${place.name}" style="width:220px; max-height:150px; margin-top:5px;" />`
          : `<div style="margin-top:5px;">ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;

        marker.bindPopup(
          `<b>${place.name}</b><br/>
           ì¹´í…Œê³ ë¦¬: ${cat}<br/>
           ${imageTag}`
        ).openPopup();
      })
      .catch(err => {
        console.error('ì´ë¯¸ì§€ ì¡°íšŒ ì‹¤íŒ¨:', err);
        marker.bindPopup(`<b>${place.name}</b><br/>ì¹´í…Œê³ ë¦¬: ${cat}`).openPopup();
      });
  });

  markerLayer.addLayer(marker);
});


          map.setView([lat, lon], 12);
        })
        .catch(err => {
          console.error('ì¶”ì²œ API í˜¸ì¶œ ì‹¤íŒ¨:', err);
        });
    }

    // ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
    document.getElementById('getRecommendations').addEventListener('click', getRecommendations);
  </script>
</body>
</html>
